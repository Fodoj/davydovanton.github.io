---
layout: post
title: "Seed файл и вы"
---

1. Введение, описание проблеммы, расказ про веселье
2. разбираем задачу
3. чем пользуемся
4. Пишем
5. Что можно добавить
6. вывод

Совсем не давно на работе потребовалось заполнить совсем новый проект данными для дальнейшего тестирования и разработки. Конечно же, данные должны просто быть и первое, о чем я подумал, был seed файл, поэтому сегодня мы поговорим именно о нем. Как всем известно данный файл служит для генерации данных в рельсовых приложениях. Вы пишите скрипт, выполняете `rake db:seed` и радуетесь жизни. В моем случае данные были типовыми, а именно, нужно было сгенерировать: пользователей, посты и комментарии к этим постам. Я думаю все прекрасно понимают, как все взаимосвязанно, поэтому на этом останавливаться не вижу особого смысла.

Обычная практика многих людей - задать одинаковые данные для всех типов данных и наплодить их с десяток. Смотрится это обычно как-то так:

{% highlight ruby %}
user = {
  name:  'Jon'
  email: 'my@email.org'
  password: '12345678',
  password_confirmation: '12345678'  
  }

post = {
  title:  'My Post'
  body:   'My body'
  }

comment = { body: 'comment' }

10.times do
  my_user = User.create(user)
  my_post = my_user.create_post(post)
  my_post.create_comment(user, comment)
end
{% endhighlight %}

Но согласитесь, это скучно, банально и задевает чувство прекрасного. Поэтому давайте плюнем на все, и развлечемся создав свой собственный, изменяющийся из раза в раз мир :)

АТЕНШЕН(!!!исправить!!!): далее будет много рандома, благодаря которому поддерживать все это или искать ошибки становиться все сложнее и сложнее. Поэтому, использование генераторов основанных на рандоме не рекомендуется для продакшена. В крайнем случае использовать аккуратно и с умом.

Для того, что бы наш мир существовал, нам нужны люди. Наша цель - создать абсолютно разных пользователей, не похожих друг на друга. Конечно же, первое, что всплывает в голову - замечательный гем [faker](https://github.com/stympy/faker) который поможет нам генерировать произвольные имена и почтовые адресса для наших пользователей. Но при всем при этом, не будем забывать про нашего админа. Так же, давайте зададим рандомное количество пользователей в интервале от 18 до 25(числа, как вы догадались, могут быть абсолютно любые):

{% highlight ruby %}
user = {
  name:  admin
  email: admin@my_app.com
  password: '12345678',
  password_confirmation: '12345678'  
  }

rnd = Random.new
user_count = rnd.rand(18..23)
User.create(user)

user_count.times do
  user[:name]  = Faker::Name.name
  user[:email] = Faker::Internet.email  
  User.create(user)
end
{% endhighlight %}

Cобственно я уверен, faker поможет вам сгенерировать почти любую информацию, стоит только открыть доки. Ну а если вам не угодил faker, то существует достаточно [много](https://www.ruby-toolbox.com/categories/random_data_generation) других data генераторов.

Не думаю, что тут что-то было сложно, поэтому пререйдем к постам. Сказать по правде, в нашем проекте посты состояли из строго заданных кусков html-a поэтому тут ничего не оставалось, кроме как делать в лоб. Единственный момент, мы будем выбирать произвольно польователя, что бы от его имени создавать наш пост:

{% highlight ruby %}
posts = [
  {
    title:  'My first Post'
    body:   'My body'
  },
  {
    title:  'My second Post'
    body:   'My body'    
  },
  # Еще какое-то количество данных для постов ...
]

def rnd_user(count, rnd)
  random_user_id = rnd.rand(1..(count))
  User.find(random_user_id)
end

posts.each do |post|
  rand_user = rnd_user user_count, rnd

  post[:user_id] = rand_user.id
  created_post = rand_user.create_post(post)
end
{% endhighlight %}



{% highlight ruby %}
{% endhighlight %}

